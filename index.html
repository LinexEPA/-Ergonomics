import React, { useState, useRef, useEffect, useMemo } from 'react';
import { Upload, Play, Pause, RotateCcw, Activity, AlertTriangle, CheckCircle, Ruler, Calculator, Info } from 'lucide-react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, AreaChart, Area } from 'recharts';

const ErgoLiftApp = () => {
  const [activeTab, setActiveTab] = useState('video'); // video or calculator
  
  // --- Physics Constants & State ---
  const [bodyWeight, setBodyWeight] = useState(70); // kg
  const [loadWeight, setLoadWeight] = useState(10); // kg
  const [trunkAngle, setTrunkAngle] = useState(0); // degrees (flexion)
  const [loadDistance, setLoadDistance] = useState(40); // cm (horizontal distance from spine)
  
  // Constant approximations for 2D Biomechanical Model
  const TORSO_WEIGHT_RATIO = 0.6; // Approx % of body weight above L5/S1
  const MUSCLE_MOMENT_ARM = 0.05; // 5cm (Distance from erector spinae to pivot)
  const TORSO_COM_DIST = 0.25; // 25cm (Approx distance to torso center of mass)
  
  // --- Video Handling State ---
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const [videoSrc, setVideoSrc] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  const [points, setPoints] = useState([]); // Array of {x, y}
  const [measuredAngle, setMeasuredAngle] = useState(null);

  // --- Calculations ---
  const calculationResult = useMemo(() => {
    // Convert units
    const torsoMass = bodyWeight * TORSO_WEIGHT_RATIO;
    const loadMass = parseFloat(loadWeight);
    const g = 9.81;
    const angleRad = (trunkAngle * Math.PI) / 180;
    const loadDistM = loadDistance / 100;

    // 1. Calculate Moments (Torques)
    // Torque from Upper Body Weight (Torso tries to fall forward)
    // Moment = Force * perpendicular distance = (Mass * g) * (COM_Dist * sin(theta))
    const momentTorso = (torsoMass * g) * (TORSO_COM_DIST * Math.sin(angleRad));
    
    // Torque from External Load
    const momentLoad = (loadMass * g) * (loadDistM + (TORSO_COM_DIST * Math.sin(angleRad) * 0.5)); 
    // Simplified assumption: Load moves slightly away as we bend, but primarily defined by loadDistance input

    const totalMoment = momentTorso + momentLoad;

    // 2. Calculate Muscle Force Required to counteract Moment
    // Force_muscle * 0.05m = Total_Moment
    const forceMuscle = totalMoment / MUSCLE_MOMENT_ARM;

    // 3. Calculate Total Compression on L5/S1
    // Compression = Muscle Force + Component of Body Weight + Component of Load Weight
    // Cosine component acts directly down the spine
    const compTorso = (torsoMass * g) * Math.cos(angleRad);
    const compLoad = (loadMass * g) * Math.cos(angleRad);
    
    const totalCompression = forceMuscle + compTorso + compLoad;
    
    return {
      totalCompression: Math.round(totalCompression),
      muscleForce: Math.round(forceMuscle),
      riskLevel: totalCompression > 3400 ? 'High' : (totalCompression > 2500 ? 'Medium' : 'Low'),
      momentTorso: Math.round(momentTorso),
      momentLoad: Math.round(momentLoad)
    };
  }, [bodyWeight, loadWeight, trunkAngle, loadDistance]);

  // --- Handlers ---

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      setVideoSrc(url);
      setPoints([]);
      setMeasuredAngle(null);
    }
  };

  const togglePlay = () => {
    if (videoRef.current) {
      if (isPlaying) videoRef.current.pause();
      else videoRef.current.play();
      setIsPlaying(!isPlaying);
    }
  };

  const handleCanvasClick = (e) => {
    if (!videoSrc) return;
    
    // Get coordinates relative to canvas
    const rect = canvasRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const newPoints = [...points, { x, y }];
    
    if (newPoints.length > 2) {
      // Reset if trying to add more than 2 points (Hip, Shoulder)
      setPoints([{ x, y }]);
      setMeasuredAngle(null);
    } else {
      setPoints(newPoints);
      
      if (newPoints.length === 2) {
        // Calculate Angle
        // Point 1: Hip (Pivot), Point 2: Shoulder
        const p1 = newPoints[0];
        const p2 = newPoints[1];
        
        // Calculate angle relative to vertical (0 degrees is standing straight up)
        const deltaX = p2.x - p1.x;
        const deltaY = p1.y - p2.y; // Y is inverted in canvas
        
        // Atan2 gives angle from X axis. We want angle from Y axis (vertical).
        // Vertical vector is (0, 1). 
        // Simple geometry: 
        let angleDeg = Math.atan2(Math.abs(deltaX), Math.abs(deltaY)) * (180 / Math.PI);
        
        setMeasuredAngle(Math.round(angleDeg));
        setTrunkAngle(Math.round(angleDeg)); // Auto-update the calculator
      }
    }
  };

  // Draw overlay
  useEffect(() => {
    if (!canvasRef.current) return;
    const ctx = canvasRef.current.getContext('2d');
    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);

    // Draw points
    points.forEach((p, index) => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
      ctx.fillStyle = index === 0 ? '#3b82f6' : '#ef4444'; // Blue for hip, Red for shoulder
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.stroke();
      
      // Label
      ctx.fillStyle = 'white';
      ctx.font = '12px sans-serif';
      ctx.fillText(index === 0 ? '髖關節 (Hip)' : '肩膀 (Shoulder)', p.x + 10, p.y);
    });

    // Draw Line
    if (points.length === 2) {
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      ctx.lineTo(points[1].x, points[1].y);
      ctx.strokeStyle = '#fbbf24';
      ctx.lineWidth = 3;
      ctx.stroke();

      // Draw Vertical Reference
      ctx.beginPath();
      ctx.setLineDash([5, 5]);
      ctx.moveTo(points[0].x, points[0].y);
      ctx.lineTo(points[0].x, points[0].y - 100);
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Draw Angle text
      if (measuredAngle !== null) {
        ctx.fillStyle = '#fbbf24';
        ctx.font = 'bold 24px sans-serif';
        ctx.fillText(`${measuredAngle}°`, points[0].x + 10, points[0].y - 40);
      }
    }
  }, [points, measuredAngle, videoSrc]);

  // Sync video size to canvas
  const handleLoadedMetadata = () => {
    if (videoRef.current && canvasRef.current) {
      canvasRef.current.width = videoRef.current.videoWidth;
      canvasRef.current.height = videoRef.current.videoHeight;
    }
  };


  // --- Visualization Data for Chart ---
  const riskData = useMemo(() => {
    const data = [];
    for (let i = 0; i <= 90; i+=5) {
        // Recalculate simply for graph
        const rad = (i * Math.PI) / 180;
        const tm = (bodyWeight * TORSO_WEIGHT_RATIO * 9.81) * (TORSO_COM_DIST * Math.sin(rad));
        const lm = (loadWeight * 9.81) * ((loadDistance/100) + (TORSO_COM_DIST * Math.sin(rad) * 0.5));
        const force = (tm + lm) / MUSCLE_MOMENT_ARM;
        const comp = force + ((bodyWeight * TORSO_WEIGHT_RATIO * 9.81) * Math.cos(rad)) + ((loadWeight * 9.81) * Math.cos(rad));
        data.push({
            angle: i,
            compression: Math.round(comp),
            limit: 3400
        });
    }
    return data;
  }, [bodyWeight, loadWeight, loadDistance]);

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
      {/* Header */}
      <header className="bg-slate-900 text-white p-4 shadow-md flex items-center justify-between">
        <div className="flex items-center space-x-2">
          <Activity className="text-blue-400" />
          <h1 className="text-xl font-bold">ErgoLift 智慧人因負荷分析儀</h1>
        </div>
        <div className="text-xs text-slate-400">
          基於 2D 平面生物力學模型 (L5/S1 Compression)
        </div>
      </header>

      <main className="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* Left Column: Input & Video */}
        <div className="lg:col-span-7 space-y-6">
          
          {/* Tabs */}
          <div className="flex space-x-2 bg-white p-1 rounded-lg shadow-sm border border-slate-200">
            <button 
              onClick={() => setActiveTab('video')}
              className={`flex-1 py-2 px-4 rounded-md flex items-center justify-center space-x-2 transition-colors ${activeTab === 'video' ? 'bg-blue-100 text-blue-700 font-medium' : 'hover:bg-slate-50 text-slate-500'}`}
            >
              <Upload size={18} />
              <span>影片分析</span>
            </button>
            <button 
              onClick={() => setActiveTab('calculator')}
              className={`flex-1 py-2 px-4 rounded-md flex items-center justify-center space-x-2 transition-colors ${activeTab === 'calculator' ? 'bg-blue-100 text-blue-700 font-medium' : 'hover:bg-slate-50 text-slate-500'}`}
            >
              <Calculator size={18} />
              <span>參數微調</span>
            </button>
          </div>

          {/* Video Analyzer Interface */}
          {activeTab === 'video' && (
            <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden">
              <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 className="font-semibold text-slate-700 flex items-center">
                  <Ruler className="w-4 h-4 mr-2" />
                  動作角度測量
                </h3>
                <label className="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-lg transition-colors flex items-center">
                  <Upload size={16} className="mr-2" />
                  上傳影片
                  <input type="file" accept="video/*" className="hidden" onChange={handleFileUpload} />
                </label>
              </div>

              <div className="relative bg-black aspect-video flex items-center justify-center overflow-hidden">
                {!videoSrc ? (
                  <div className="text-slate-400 text-center p-8">
                    <Upload size={48} className="mx-auto mb-4 opacity-50" />
                    <p>請上傳工作影片 (MP4/MOV)</p>
                    <p className="text-sm mt-2 opacity-70">系統將輔助您標記骨架並計算負荷</p>
                  </div>
                ) : (
                  <div className="relative w-full h-full">
                    <video 
                      ref={videoRef}
                      src={videoSrc}
                      className="absolute inset-0 w-full h-full object-contain"
                      onLoadedMetadata={handleLoadedMetadata}
                      onEnded={() => setIsPlaying(false)}
                      playsInline
                    />
                    <canvas 
                      ref={canvasRef}
                      className="absolute inset-0 w-full h-full cursor-crosshair z-10"
                      onClick={handleCanvasClick}
                    />
                  </div>
                )}
              </div>

              <div className="p-4 flex items-center justify-between bg-slate-50 border-t border-slate-200">
                <div className="flex space-x-2">
                  <button onClick={togglePlay} disabled={!videoSrc} className="p-2 bg-slate-200 rounded-full hover:bg-slate-300 disabled:opacity-50">
                    {isPlaying ? <Pause size={20} /> : <Play size={20} />}
                  </button>
                  <button onClick={() => {
                    setPoints([]);
                    setMeasuredAngle(null);
                  }} className="p-2 bg-slate-200 rounded-full hover:bg-slate-300 text-slate-600" title="重置標記">
                    <RotateCcw size={20} />
                  </button>
                </div>
                <div className="text-sm text-slate-600">
                  {measuredAngle ? (
                    <span className="font-bold text-blue-600 text-lg">已測量角度: {measuredAngle}°</span>
                  ) : (
                    <span>操作提示: 暫停影片 ➔ 點擊臀部 ➔ 點擊肩膀</span>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Manual Input Interface */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 className="font-semibold text-slate-700 mb-4 flex items-center">
              <Calculator className="w-4 h-4 mr-2" />
              作業參數設定
            </h3>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">軀幹彎曲角度 (Trunk Angle)</label>
                  <div className="flex items-center space-x-4">
                    <input 
                      type="range" min="0" max="90" value={trunkAngle} 
                      onChange={(e) => setTrunkAngle(Number(e.target.value))}
                      className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                    />
                    <span className="w-12 text-right font-mono font-bold text-blue-600">{trunkAngle}°</span>
                  </div>
                  <p className="text-xs text-slate-400 mt-1">來自影片測量或手動調整</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">手中物體重量 (Load Weight)</label>
                  <div className="flex items-center space-x-4">
                    <input 
                      type="range" min="0" max="50" value={loadWeight} 
                      onChange={(e) => setLoadWeight(Number(e.target.value))}
                      className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                    />
                    <span className="w-12 text-right font-mono font-bold text-blue-600">{loadWeight}kg</span>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">作業者體重 (Body Weight)</label>
                  <div className="flex items-center space-x-4">
                    <input 
                      type="number" value={bodyWeight} 
                      onChange={(e) => setBodyWeight(Number(e.target.value))}
                      className="w-full border border-slate-300 rounded px-3 py-1 text-sm"
                    />
                    <span className="text-slate-500 text-sm">kg</span>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">物體離脊椎水平距離 (Distance)</label>
                  <div className="flex items-center space-x-4">
                    <input 
                      type="number" value={loadDistance} 
                      onChange={(e) => setLoadDistance(Number(e.target.value))}
                      className="w-full border border-slate-300 rounded px-3 py-1 text-sm"
                    />
                    <span className="text-slate-500 text-sm">cm</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Right Column: Results & Dashboard */}
        <div className="lg:col-span-5 space-y-6">
          
          {/* Main Score Card */}
          <div className={`rounded-xl shadow-lg border p-6 text-white transition-colors duration-500 ${
            calculationResult.riskLevel === 'High' ? 'bg-red-500 border-red-600' : 
            calculationResult.riskLevel === 'Medium' ? 'bg-yellow-500 border-yellow-600' : 
            'bg-emerald-500 border-emerald-600'
          }`}>
            <div className="flex justify-between items-start mb-4">
              <div>
                <h2 className="text-3xl font-bold">{calculationResult.totalCompression} N</h2>
                <p className="text-white/90 text-sm font-medium mt-1">L5/S1 椎間盤預估壓力</p>
              </div>
              <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                 {calculationResult.riskLevel === 'High' ? <AlertTriangle size={32} /> : <CheckCircle size={32} />}
              </div>
            </div>

            <div className="space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-white/80">NIOSH 安全上限:</span>
                <span className="font-mono">3,400 N</span>
              </div>
              <div className="w-full bg-black/20 rounded-full h-2">
                <div 
                  className="bg-white h-2 rounded-full transition-all duration-500"
                  style={{ width: `${Math.min((calculationResult.totalCompression / 6000) * 100, 100)}%` }}
                ></div>
              </div>
              <div className="flex justify-between items-center pt-2">
                <span className="font-bold uppercase tracking-wider text-sm">{calculationResult.riskLevel} RISK</span>
                {calculationResult.riskLevel === 'High' && (
                  <span className="text-xs bg-white text-red-600 px-2 py-1 rounded font-bold">建議立即改善</span>
                )}
              </div>
            </div>
          </div>

          {/* Details Panel */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h3 className="font-semibold text-slate-700 mb-4 text-sm uppercase tracking-wide">力學分析細節</h3>
            <div className="space-y-4 text-sm">
              <div className="flex justify-between py-2 border-b border-slate-100">
                <span className="text-slate-500">背部肌肉收縮力 (Muscle Force)</span>
                <span className="font-mono font-medium">{calculationResult.muscleForce} N</span>
              </div>
              <div className="flex justify-between py-2 border-b border-slate-100">
                <span className="text-slate-500">上身重力力矩 (Torso Moment)</span>
                <span className="font-mono font-medium">{calculationResult.momentTorso} Nm</span>
              </div>
              <div className="flex justify-between py-2 border-b border-slate-100">
                <span className="text-slate-500">負重力矩 (Load Moment)</span>
                <span className="font-mono font-medium">{calculationResult.momentLoad} Nm</span>
              </div>
            </div>
          </div>

          {/* Chart */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 h-64">
            <h3 className="font-semibold text-slate-700 mb-2 text-xs">角度 vs 壓力趨勢圖</h3>
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={riskData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                <defs>
                  <linearGradient id="colorComp" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.1}/>
                    <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                <XAxis dataKey="angle" tick={{fontSize: 10}} label={{ value: '角度', position: 'insideBottomRight', offset: -5, fontSize: 10 }} />
                <YAxis tick={{fontSize: 10}} />
                <Tooltip 
                  contentStyle={{backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0', fontSize: '12px'}}
                  formatter={(value) => [`${value} N`, '壓力']}
                />
                <ReferenceLine y={3400} stroke="red" strokeDasharray="3 3" label={{ value: '危險線', position: 'insideTopRight', fill: 'red', fontSize: 10 }} />
                <Area type="monotone" dataKey="compression" stroke="#3b82f6" fillOpacity={1} fill="url(#colorComp)" />
                {/* Current Position Dot */}
                <ReferenceLine x={trunkAngle} stroke="#fbbf24" strokeWidth={2} label={{ value: '目前', fill: '#fbbf24', fontSize: 10 }} />
              </AreaChart>
            </ResponsiveContainer>
          </div>
          
          <div className="bg-blue-50 p-4 rounded-lg flex items-start space-x-3">
             <Info className="text-blue-500 flex-shrink-0 mt-1" size={18} />
             <div className="text-xs text-blue-800 leading-relaxed">
               <strong>計算原理：</strong> 採用 2D 靜態平面模型。假設背部伸肌力臂為 5cm，上半身重心距離 L5/S1 約 25cm。公式考慮了身體自重產生的力矩以及外在負重產生的力矩。
               <br/><br/>
               <em className="opacity-70">免責聲明：此工具僅供人因工程初步評估，不可替代專業醫療診斷。</em>
             </div>
          </div>

        </div>
      </main>
    </div>
  );
};

export default ErgoLiftApp;
