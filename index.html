import React, { useState, useRef, useEffect, useMemo } from 'react';
import { Upload, Play, Pause, RotateCcw, Activity, AlertTriangle, CheckCircle, Ruler, Calculator, Info, Users, Crosshair, Settings2, User, Move } from 'lucide-react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine, Cell } from 'recharts';

const ErgoLiftApp = () => {
  const [activeTab, setActiveTab] = useState('video'); // video or calculator
  
  // --- Physics Constants & State ---
  const [mode, setMode] = useState('single'); // 'single' or 'team'
  const [bodyWeight, setBodyWeight] = useState(70); // kg
  const [bodyHeight, setBodyHeight] = useState(170); // cm
  const [totalLoad, setTotalLoad] = useState(10); // kg (Total object weight)
  const [partnerShare, setPartnerShare] = useState(50); // % (How much partner helps)
  
  // Anthropometric Data (Based on Dempster / Winter)
  const ANTHRO = {
    forearm: { lenRatio: 0.146, massRatio: 0.016, comRatio: 0.43 }, // Elbow to Wrist
    upperarm: { lenRatio: 0.186, massRatio: 0.028, comRatio: 0.436 }, // Shoulder to Elbow
    trunk: { massRatio: 0.578, comRatio: 0.66 } // Head+Arms+Trunk approx
  };
  const MOMENT_ARMS = { erectorSpinae: 0.05 }; // 5cm
  
  // --- Video Handling State ---
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const [videoSrc, setVideoSrc] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);
  
  // Points: [Wrist, Elbow, Shoulder, Hip]
  const [points, setPoints] = useState([]); 
  
  const POINT_NAMES = ['手腕 (Wrist)', '手肘 (Elbow)', '肩膀 (Shoulder)', '髖關節 (Hip)'];
  const POINT_COLORS = ['#fbbf24', '#a855f7', '#3b82f6', '#ef4444']; // Yellow, Purple, Blue, Red

  // --- Calculations (Inverse Dynamics) ---
  const calculationResult = useMemo(() => {
    // 1. Determine Effective Load
    const effectiveLoadKg = mode === 'team' 
        ? totalLoad * (1 - (partnerShare / 100)) 
        : parseFloat(totalLoad);

    const g = 9.81;
    
    // Default / Placeholder values if points are missing
    if (points.length < 4) {
        // Fallback for simple calculator mode without video points:
        // We assume a standard "stoop" lift posture if no video points: 
        // Trunk 45deg, UpperArm 20deg, Forearm -20deg (approx)
        // This allows the calculator to show something before video analysis
        return {
            totalCompression: 0,
            sMoment: 0, 
            eMoment: 0, 
            l5Moment: 0,
            riskLevel: 'Low',
            effectiveLoad: effectiveLoadKg,
            trunkAng: 0,
            shoulderAng: 0
        };
    }

    const pW = points[0]; // Wrist
    const pE = points[1]; // Elbow
    const pS = points[2]; // Shoulder
    const pH = points[3]; // Hip

    // 2. Geometry & Conversion
    const H_meters = bodyHeight / 100;
    
    // Estimated Segment Lengths (Meters) based on body height
    const L_forearm = H_meters * ANTHRO.forearm.lenRatio;
    const L_upperarm = H_meters * ANTHRO.upperarm.lenRatio;
    const L_trunk = H_meters * 0.3; // Approx trunk length (Shoulder to Hip)

    // Calculate Angles relative to vertical (0 is down)
    // Canvas Y is positive down.
    const angleForearm = Math.atan2(pW.x - pE.x, pE.y - pW.y); 
    const angleUpperarm = Math.atan2(pE.x - pS.x, pS.y - pE.y);
    const angleTrunk = Math.atan2(pS.x - pH.x, pH.y - pS.y);

    // Angles for Display (Degrees)
    const trunkAngDeg = Math.round(Math.abs(angleTrunk * (180/Math.PI)));
    const shoulderAngDeg = Math.round(Math.abs(angleUpperarm * (180/Math.PI)));

    // Horizontal Moment Arms (d = L * sin(theta))
    const d_forearm_load = Math.abs(L_forearm * Math.sin(angleForearm));
    const d_forearm_com = Math.abs(L_forearm * ANTHRO.forearm.comRatio * Math.sin(angleForearm));
    
    const d_upperarm_elbow = Math.abs(L_upperarm * Math.sin(angleUpperarm));
    const d_upperarm_com = Math.abs(L_upperarm * ANTHRO.upperarm.comRatio * Math.sin(angleUpperarm));

    const d_trunk_shoulder = Math.abs(L_trunk * Math.sin(angleTrunk));
    const d_trunk_com = Math.abs(L_trunk * 0.5 * Math.sin(angleTrunk)); // Simplified

    // 3. Step-by-Step Moment Calculation (Top-Down)
    
    // A. ELBOW MOMENT
    const F_load = effectiveLoadKg * g;
    const F_forearm = (bodyWeight * ANTHRO.forearm.massRatio) * g;
    const M_elbow = (F_load * d_forearm_load) + (F_forearm * d_forearm_com);

    // B. SHOULDER MOMENT
    const F_elbow_total = F_load + F_forearm; 
    const F_upperarm = (bodyWeight * ANTHRO.upperarm.massRatio) * g;
    const M_shoulder = M_elbow + (F_elbow_total * d_upperarm_elbow) + (F_upperarm * d_upperarm_com);

    // C. L5/S1 MOMENT
    // Mass above L5S1 minus arms (Head + Trunk) approx 50% BW
    const F_shoulder_total = F_elbow_total + F_upperarm;
    const F_trunk = (bodyWeight * 0.50) * g; 
    const M_l5s1 = M_shoulder + (F_shoulder_total * d_trunk_shoulder) + (F_trunk * d_trunk_com);

    // 4. Compression
    const F_muscle = M_l5s1 / MOMENT_ARMS.erectorSpinae;
    // Component of weight acting parallel to spine (Compression)
    const Total_Mass_Above = effectiveLoadKg + (bodyWeight * 0.6);
    const F_gravity_comp = (Total_Mass_Above * g) * Math.cos(angleTrunk);
    
    const totalCompression = F_muscle + F_gravity_comp;
    
    return {
      totalCompression: Math.round(totalCompression),
      sMoment: Math.round(M_shoulder),
      eMoment: Math.round(M_elbow),
      l5Moment: Math.round(M_l5s1),
      riskLevel: totalCompression > 3400 ? 'High' : (totalCompression > 2500 ? 'Medium' : 'Low'),
      effectiveLoad: effectiveLoadKg.toFixed(1),
      trunkAng: trunkAngDeg,
      shoulderAng: shoulderAngDeg
    };
  }, [mode, totalLoad, partnerShare, bodyWeight, bodyHeight, points]);

  // --- Handlers ---

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      setVideoSrc(url);
      setPoints([]);
    }
  };

  const togglePlay = () => {
    if (videoRef.current) {
      if (isPlaying) videoRef.current.pause();
      else videoRef.current.play();
      setIsPlaying(!isPlaying);
    }
  };

  const handleCanvasClick = (e) => {
    if (!videoSrc) return;
    if (points.length >= 4) return; // Max 4 points

    const rect = canvasRef.current.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const newPoints = [...points, { x, y }];
    setPoints(newPoints);
  };

  const resetPoints = () => {
      setPoints([]);
  };

  // Draw overlay
  useEffect(() => {
    if (!canvasRef.current) return;
    const ctx = canvasRef.current.getContext('2d');
    ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);

    // Draw Lines
    if (points.length > 1) {
        ctx.beginPath();
        ctx.moveTo(points[0].x, points[0].y);
        for(let i=1; i<points.length; i++) {
            ctx.lineTo(points[i].x, points[i].y);
        }
        ctx.strokeStyle = '#fbbf24'; // Amber-400
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
    }

    // Draw Points
    points.forEach((p, index) => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 6, 0, 2 * Math.PI);
      ctx.fillStyle = POINT_COLORS[index];
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.stroke();
      
      // Label
      ctx.fillStyle = 'white';
      ctx.font = '12px sans-serif';
      ctx.shadowColor = "rgba(0,0,0,0.5)";
      ctx.shadowBlur = 4;
      ctx.fillText(POINT_NAMES[index], p.x + 10, p.y);
      ctx.shadowBlur = 0;
    });

  }, [points, videoSrc]);

  // Sync video size
  const handleLoadedMetadata = () => {
    if (videoRef.current && canvasRef.current) {
      canvasRef.current.width = videoRef.current.videoWidth;
      canvasRef.current.height = videoRef.current.videoHeight;
    }
  };

  // Chart Data
  const chartData = [
    { name: '手肘 (Elbow)', moment: calculationResult.eMoment, fill: '#a855f7' },
    { name: '肩膀 (Shoulder)', moment: calculationResult.sMoment, fill: '#3b82f6' },
    { name: '腰椎 (L5/S1)', moment: calculationResult.l5Moment, fill: '#10b981' },
  ];

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
      {/* Header */}
      <header className="bg-slate-900 text-white p-4 shadow-md flex items-center justify-between">
        <div className="flex items-center space-x-2">
          <Activity className="text-blue-400" />
          <h1 className="text-xl font-bold">ErgoLift Pro <span className="text-xs bg-blue-600 px-2 py-0.5 rounded ml-2">v2.0</span></h1>
        </div>
        <div className="text-xs text-slate-400">
          多關節逆動力學分析 (Inverse Dynamics)
        </div>
      </header>

      <main className="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* Left Column: Input & Video */}
        <div className="lg:col-span-7 space-y-6">
          
          {/* Tabs */}
          <div className="flex space-x-2 bg-white p-1 rounded-lg shadow-sm border border-slate-200">
            <button 
              onClick={() => setActiveTab('video')}
              className={`flex-1 py-2 px-4 rounded-md flex items-center justify-center space-x-2 transition-colors ${activeTab === 'video' ? 'bg-blue-100 text-blue-700 font-medium' : 'hover:bg-slate-50 text-slate-500'}`}
            >
              <Upload size={18} />
              <span>影片分析</span>
            </button>
            <button 
              onClick={() => setActiveTab('calculator')}
              className={`flex-1 py-2 px-4 rounded-md flex items-center justify-center space-x-2 transition-colors ${activeTab === 'calculator' ? 'bg-blue-100 text-blue-700 font-medium' : 'hover:bg-slate-50 text-slate-500'}`}
            >
              <Calculator size={18} />
              <span>參數微調</span>
            </button>
          </div>

          {/* Video Analyzer Interface */}
          {activeTab === 'video' && (
            <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden relative">
              <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 className="font-semibold text-slate-700 flex items-center">
                  <Crosshair className="w-4 h-4 mr-2" />
                  骨架標記 ({points.length}/4)
                </h3>
                <label className="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white text-sm px-4 py-2 rounded-lg transition-colors flex items-center">
                  <Upload size={16} className="mr-2" />
                  上傳影片
                  <input type="file" accept="video/*" className="hidden" onChange={handleFileUpload} />
                </label>
              </div>

              <div className="relative bg-black aspect-video flex items-center justify-center overflow-hidden group">
                {!videoSrc ? (
                  <div className="text-slate-400 text-center p-8">
                    <Users size={48} className="mx-auto mb-4 opacity-50" />
                    <p>支援雙人搬運 & 多關節分析</p>
                    <p className="text-sm mt-2 opacity-70">上傳後請依序點擊: 手腕 ➔ 手肘 ➔ 肩膀 ➔ 髖部</p>
                  </div>
                ) : (
                  <div className="relative w-full h-full">
                    <video 
                      ref={videoRef}
                      src={videoSrc}
                      className="absolute inset-0 w-full h-full object-contain"
                      onLoadedMetadata={handleLoadedMetadata}
                      onEnded={() => setIsPlaying(false)}
                      playsInline
                    />
                    <canvas 
                      ref={canvasRef}
                      className="absolute inset-0 w-full h-full cursor-crosshair z-10"
                      onClick={handleCanvasClick}
                    />
                    
                    {/* Floating Guide */}
                    {points.length < 4 && (
                        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full text-sm font-bold backdrop-blur-sm pointer-events-none transition-all border border-white/20">
                            請點擊: <span style={{color: POINT_COLORS[points.length]}}>{POINT_NAMES[points.length]}</span>
                        </div>
                    )}
                  </div>
                )}
              </div>

              <div className="p-4 flex items-center justify-between bg-slate-50 border-t border-slate-200">
                <div className="flex space-x-2">
                  <button onClick={togglePlay} disabled={!videoSrc} className="p-2 bg-slate-200 rounded-full hover:bg-slate-300 disabled:opacity-50">
                    {isPlaying ? <Pause size={20} /> : <Play size={20} />}
                  </button>
                  <button onClick={resetPoints} className="p-2 bg-slate-200 rounded-full hover:bg-slate-300 text-slate-600" title="重置標記">
                    <RotateCcw size={20} />
                  </button>
                </div>
                <div className="text-sm text-slate-600 text-right">
                    <div className="text-xs text-slate-400">當前模式</div>
                    <div className="font-bold text-blue-600">{mode === 'single' ? '單人作業' : '雙人協作'}</div>
                </div>
              </div>
            </div>
          )}

          {/* Manual Input Interface */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-slate-700 flex items-center">
                <Settings2 className="w-4 h-4 mr-2" />
                參數設定
                </h3>
                <div className="flex bg-slate-100 p-1 rounded-lg">
                    <button 
                        onClick={() => setMode('single')}
                        className={`px-3 py-1 text-sm rounded-md transition-all ${mode === 'single' ? 'bg-white shadow text-blue-600 font-bold' : 'text-slate-500 hover:text-slate-700'}`}
                    >單人</button>
                    <button 
                        onClick={() => setMode('team')}
                        className={`px-3 py-1 text-sm rounded-md transition-all ${mode === 'team' ? 'bg-white shadow text-purple-600 font-bold' : 'text-slate-500 hover:text-slate-700'}`}
                    >雙人協作</button>
                </div>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="space-y-4">
                <div className={`p-3 rounded-lg border ${mode === 'team' ? 'bg-purple-50 border-purple-100' : 'bg-blue-50 border-blue-100'}`}>
                  <label className="block text-sm font-bold text-slate-700 mb-1">
                      {mode === 'team' ? '總負重 (Total Weight)' : '手中物體重量 (Load Weight)'}
                  </label>
                  <div className="flex items-center space-x-4">
                    <input 
                      type="range" min="0" max="150" value={totalLoad} 
                      onChange={(e) => setTotalLoad(Number(e.target.value))}
                      className={`flex-1 h-2 rounded-lg appearance-none cursor-pointer ${mode === 'team' ? 'bg-purple-200 accent-purple-600' : 'bg-blue-200 accent-blue-600'}`}
                    />
                    <span className="w-16 text-right font-mono font-bold text-slate-700">{totalLoad}kg</span>
                  </div>
                </div>

                {mode === 'team' && (
                    <div className="p-3 bg-purple-50 rounded-lg border border-purple-100">
                        <label className="block text-sm font-bold text-purple-800 mb-1">夥伴分擔比例 (Partner Share)</label>
                        <div className="flex items-center space-x-4">
                            <input 
                            type="range" min="0" max="100" value={partnerShare} 
                            onChange={(e) => setPartnerShare(Number(e.target.value))}
                            className="flex-1 h-2 bg-purple-200 rounded-lg appearance-none cursor-pointer accent-purple-600"
                            />
                            <span className="w-16 text-right font-mono font-bold text-purple-700">{partnerShare}%</span>
                        </div>
                        <p className="text-xs text-purple-600 mt-1">此人實際負重: <strong>{calculationResult.effectiveLoad} kg</strong></p>
                    </div>
                )}

                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">作業者體重 (Body Weight)</label>
                  <div className="flex items-center space-x-4">
                    <input 
                      type="number" value={bodyWeight} 
                      onChange={(e) => setBodyWeight(Number(e.target.value))}
                      className="w-full border border-slate-300 rounded px-3 py-1 text-sm"
                    />
                    <span className="text-slate-500 text-sm">kg</span>
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">身高 (Height) <span className="text-xs text-slate-400">- 估算臂長用</span></label>
                  <div className="flex items-center space-x-4">
                    <input 
                      type="number" value={bodyHeight} 
                      onChange={(e) => setBodyHeight(Number(e.target.value))}
                      className="w-full border border-slate-300 rounded px-3 py-1 text-sm"
                    />
                    <span className="text-slate-500 text-sm">cm</span>
                  </div>
                </div>

                <div className="pt-2 border-t border-slate-100">
                    <h4 className="text-xs font-semibold text-slate-500 uppercase mb-2">自動偵測角度</h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                        <div className="bg-slate-50 p-2 rounded">
                            <span className="block text-xs text-slate-400">軀幹前彎</span>
                            <span className="font-mono font-bold text-slate-700">{calculationResult.trunkAng}°</span>
                        </div>
                        <div className="bg-slate-50 p-2 rounded">
                            <span className="block text-xs text-slate-400">上臂抬舉</span>
                            <span className="font-mono font-bold text-slate-700">{calculationResult.shoulderAng}°</span>
                        </div>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Right Column: Results & Dashboard */}
        <div className="lg:col-span-5 space-y-6">
          
          {/* Main Score Card */}
          <div className={`rounded-xl shadow-lg border p-6 text-white transition-colors duration-500 relative overflow-hidden ${
            calculationResult.riskLevel === 'High' ? 'bg-red-500 border-red-600' : 
            calculationResult.riskLevel === 'Medium' ? 'bg-yellow-500 border-yellow-600' : 
            'bg-emerald-500 border-emerald-600'
          }`}>
            <div className="relative z-10">
                <div className="flex justify-between items-start mb-4">
                <div>
                    <h2 className="text-3xl font-bold">{calculationResult.totalCompression} N</h2>
                    <p className="text-white/90 text-sm font-medium mt-1">L5/S1 椎間盤預估壓力</p>
                </div>
                <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                    {calculationResult.riskLevel === 'High' ? <AlertTriangle size={32} /> : <CheckCircle size={32} />}
                </div>
                </div>

                <div className="space-y-2">
                <div className="flex justify-between text-sm">
                    <span className="text-white/80">NIOSH 安全上限:</span>
                    <span className="font-mono">3,400 N</span>
                </div>
                <div className="w-full bg-black/20 rounded-full h-2">
                    <div 
                    className="bg-white h-2 rounded-full transition-all duration-500"
                    style={{ width: `${Math.min((calculationResult.totalCompression / 6000) * 100, 100)}%` }}
                    ></div>
                </div>
                <div className="flex justify-between items-center pt-2">
                    <span className="font-bold uppercase tracking-wider text-sm">{calculationResult.riskLevel} RISK</span>
                </div>
                </div>
            </div>
          </div>

          {/* Multi-Joint Cards */}
          <div className="grid grid-cols-2 gap-4">
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <div className="flex justify-between items-start mb-1">
                        <h3 className="text-xs font-bold text-slate-500 uppercase">肩關節力矩</h3>
                        <User className="w-4 h-4 text-slate-400" />
                    </div>
                    <div className="flex items-baseline space-x-1">
                        <span className="text-2xl font-bold text-slate-700">{calculationResult.sMoment}</span>
                        <span className="text-xs text-slate-500">Nm</span>
                    </div>
                </div>
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <div className="flex justify-between items-start mb-1">
                        <h3 className="text-xs font-bold text-slate-500 uppercase">肘關節力矩</h3>
                        <Move className="w-4 h-4 text-slate-400" />
                    </div>
                    <div className="flex items-baseline space-x-1">
                        <span className="text-2xl font-bold text-slate-700">{calculationResult.eMoment}</span>
                        <span className="text-xs text-slate-500">Nm</span>
                    </div>
                </div>
          </div>

          {/* Chart */}
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 h-64">
            <h3 className="font-semibold text-slate-700 mb-2 text-xs">各部位力矩分佈 (Joint Moments)</h3>
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={chartData} margin={{ top: 10, right: 10, left: -20, bottom: 0 }}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                <XAxis dataKey="name" tick={{fontSize: 10}} />
                <YAxis tick={{fontSize: 10}} label={{ value: '力矩 (Nm)', angle: -90, position: 'insideLeft', fontSize: 10 }} />
                <Tooltip 
                  cursor={{fill: 'transparent'}}
                  contentStyle={{backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #e2e8f0', fontSize: '12px'}}
                />
                <Bar dataKey="moment" radius={[4, 4, 0, 0]}>
                    {chartData.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={entry.fill} />
                    ))}
                </Bar>
              </BarChart>
            </ResponsiveContainer>
          </div>
          
          <div className="bg-blue-50 p-4 rounded-lg flex items-start space-x-3">
             <Info className="text-blue-500 flex-shrink-0 mt-1" size={18} />
             <div className="text-xs text-blue-800 leading-relaxed">
               <strong>計算原理：</strong> 採用由外向內 (Top-Down) 的逆動力學計算。
               <ul className="list-disc pl-4 mt-1 opacity-80">
                   <li>手部受力 ➔ 計算肘部力矩</li>
                   <li>肘部力矩 + 上臂重 ➔ 計算肩部力矩</li>
                   <li>肩部力矩 + 軀幹重 ➔ 計算腰椎力矩</li>
               </ul>
             </div>
          </div>

        </div>
      </main>
    </div>
  );
};

export default ErgoLiftApp;
